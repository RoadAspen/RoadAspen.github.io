<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>什么是 Monorepo | roadaspen&#39;s blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="前进的脚步永不停歇，成长的路途一往无前">
    
    <link rel="preload" href="/assets/css/0.styles.878da1ec.css" as="style"><link rel="preload" href="/assets/js/app.54ff6683.js" as="script"><link rel="preload" href="/assets/js/2.b5bd4e97.js" as="script"><link rel="preload" href="/assets/js/8.bc8f262b.js" as="script"><link rel="prefetch" href="/assets/js/10.ed59903e.js"><link rel="prefetch" href="/assets/js/100.36542890.js"><link rel="prefetch" href="/assets/js/101.e366b30e.js"><link rel="prefetch" href="/assets/js/102.1fc5a8df.js"><link rel="prefetch" href="/assets/js/103.0943fc40.js"><link rel="prefetch" href="/assets/js/104.28b7a620.js"><link rel="prefetch" href="/assets/js/105.430005db.js"><link rel="prefetch" href="/assets/js/106.6e250684.js"><link rel="prefetch" href="/assets/js/107.7559de46.js"><link rel="prefetch" href="/assets/js/108.69a6dd1d.js"><link rel="prefetch" href="/assets/js/109.90afb4f6.js"><link rel="prefetch" href="/assets/js/11.3e10a0be.js"><link rel="prefetch" href="/assets/js/110.4ceb1543.js"><link rel="prefetch" href="/assets/js/111.53880e10.js"><link rel="prefetch" href="/assets/js/112.eb0eae7d.js"><link rel="prefetch" href="/assets/js/113.bfe8747f.js"><link rel="prefetch" href="/assets/js/114.c598e715.js"><link rel="prefetch" href="/assets/js/115.cb7a6062.js"><link rel="prefetch" href="/assets/js/116.506f1ef1.js"><link rel="prefetch" href="/assets/js/117.28b78a88.js"><link rel="prefetch" href="/assets/js/118.c7efeb65.js"><link rel="prefetch" href="/assets/js/119.2708cb64.js"><link rel="prefetch" href="/assets/js/12.8342cf70.js"><link rel="prefetch" href="/assets/js/120.4067c7d7.js"><link rel="prefetch" href="/assets/js/121.91d07b16.js"><link rel="prefetch" href="/assets/js/122.07bca51e.js"><link rel="prefetch" href="/assets/js/123.9d254cc7.js"><link rel="prefetch" href="/assets/js/124.fb568b66.js"><link rel="prefetch" href="/assets/js/125.9fc071d8.js"><link rel="prefetch" href="/assets/js/126.bbed2a05.js"><link rel="prefetch" href="/assets/js/127.f5134f54.js"><link rel="prefetch" href="/assets/js/128.e05e86f0.js"><link rel="prefetch" href="/assets/js/129.ff6a4f90.js"><link rel="prefetch" href="/assets/js/13.1c024767.js"><link rel="prefetch" href="/assets/js/130.85d5d009.js"><link rel="prefetch" href="/assets/js/131.6adde41c.js"><link rel="prefetch" href="/assets/js/132.2b40097d.js"><link rel="prefetch" href="/assets/js/133.4ebf671b.js"><link rel="prefetch" href="/assets/js/134.64720e2d.js"><link rel="prefetch" href="/assets/js/135.4b432c44.js"><link rel="prefetch" href="/assets/js/136.de473c20.js"><link rel="prefetch" href="/assets/js/137.ba84927d.js"><link rel="prefetch" href="/assets/js/138.d3d2980f.js"><link rel="prefetch" href="/assets/js/139.5804c429.js"><link rel="prefetch" href="/assets/js/14.4b025496.js"><link rel="prefetch" href="/assets/js/140.c8ca8c7e.js"><link rel="prefetch" href="/assets/js/141.118d72d1.js"><link rel="prefetch" href="/assets/js/142.24013788.js"><link rel="prefetch" href="/assets/js/143.9b73d239.js"><link rel="prefetch" href="/assets/js/144.04f2d299.js"><link rel="prefetch" href="/assets/js/145.2927eaf6.js"><link rel="prefetch" href="/assets/js/146.76598b02.js"><link rel="prefetch" href="/assets/js/147.74da52bb.js"><link rel="prefetch" href="/assets/js/148.11786e7e.js"><link rel="prefetch" href="/assets/js/149.9bb8c1f4.js"><link rel="prefetch" href="/assets/js/15.d75045a1.js"><link rel="prefetch" href="/assets/js/150.05d79b1c.js"><link rel="prefetch" href="/assets/js/151.5914cc5f.js"><link rel="prefetch" href="/assets/js/152.97498be0.js"><link rel="prefetch" href="/assets/js/153.a5dd85f8.js"><link rel="prefetch" href="/assets/js/154.7f49b905.js"><link rel="prefetch" href="/assets/js/155.9b76b320.js"><link rel="prefetch" href="/assets/js/156.5868afb7.js"><link rel="prefetch" href="/assets/js/157.4a639b76.js"><link rel="prefetch" href="/assets/js/158.197bc24d.js"><link rel="prefetch" href="/assets/js/159.af335582.js"><link rel="prefetch" href="/assets/js/16.51da189d.js"><link rel="prefetch" href="/assets/js/160.23fc7bac.js"><link rel="prefetch" href="/assets/js/161.cd53591d.js"><link rel="prefetch" href="/assets/js/162.eda417c6.js"><link rel="prefetch" href="/assets/js/163.f04e5b26.js"><link rel="prefetch" href="/assets/js/164.113cc941.js"><link rel="prefetch" href="/assets/js/165.10c0a107.js"><link rel="prefetch" href="/assets/js/166.1a9fc4fb.js"><link rel="prefetch" href="/assets/js/167.6248b33a.js"><link rel="prefetch" href="/assets/js/168.8a5ce51b.js"><link rel="prefetch" href="/assets/js/169.d5e2ec37.js"><link rel="prefetch" href="/assets/js/17.2904e637.js"><link rel="prefetch" href="/assets/js/170.4d0b3ff6.js"><link rel="prefetch" href="/assets/js/171.21113add.js"><link rel="prefetch" href="/assets/js/172.3464d97a.js"><link rel="prefetch" href="/assets/js/18.8b58231e.js"><link rel="prefetch" href="/assets/js/19.57faa86e.js"><link rel="prefetch" href="/assets/js/20.e95c11af.js"><link rel="prefetch" href="/assets/js/21.4f0d449e.js"><link rel="prefetch" href="/assets/js/22.f157ecca.js"><link rel="prefetch" href="/assets/js/23.463dc1d6.js"><link rel="prefetch" href="/assets/js/24.ebe6465d.js"><link rel="prefetch" href="/assets/js/25.482e48ff.js"><link rel="prefetch" href="/assets/js/26.64744cd8.js"><link rel="prefetch" href="/assets/js/27.e51ee4c9.js"><link rel="prefetch" href="/assets/js/28.9c6662f1.js"><link rel="prefetch" href="/assets/js/29.91424bfc.js"><link rel="prefetch" href="/assets/js/3.596efcb4.js"><link rel="prefetch" href="/assets/js/30.fda4ab88.js"><link rel="prefetch" href="/assets/js/31.d6850e62.js"><link rel="prefetch" href="/assets/js/32.7c84859c.js"><link rel="prefetch" href="/assets/js/33.321db962.js"><link rel="prefetch" href="/assets/js/34.4a849484.js"><link rel="prefetch" href="/assets/js/35.33357a3a.js"><link rel="prefetch" href="/assets/js/36.a9b9c54e.js"><link rel="prefetch" href="/assets/js/37.5c70d0b2.js"><link rel="prefetch" href="/assets/js/38.33a72a08.js"><link rel="prefetch" href="/assets/js/39.3aa59f8e.js"><link rel="prefetch" href="/assets/js/4.97657267.js"><link rel="prefetch" href="/assets/js/40.6320726b.js"><link rel="prefetch" href="/assets/js/41.2ec57a61.js"><link rel="prefetch" href="/assets/js/42.7d235750.js"><link rel="prefetch" href="/assets/js/43.1b49f579.js"><link rel="prefetch" href="/assets/js/44.725d1e82.js"><link rel="prefetch" href="/assets/js/45.6797e3d1.js"><link rel="prefetch" href="/assets/js/46.b5a6b27a.js"><link rel="prefetch" href="/assets/js/47.c4e3ad09.js"><link rel="prefetch" href="/assets/js/48.cae41db8.js"><link rel="prefetch" href="/assets/js/49.70a2875b.js"><link rel="prefetch" href="/assets/js/5.3064a982.js"><link rel="prefetch" href="/assets/js/50.fa0a7694.js"><link rel="prefetch" href="/assets/js/51.13776120.js"><link rel="prefetch" href="/assets/js/52.b900a85f.js"><link rel="prefetch" href="/assets/js/53.f53a1513.js"><link rel="prefetch" href="/assets/js/54.85cbcdc8.js"><link rel="prefetch" href="/assets/js/55.276ccf82.js"><link rel="prefetch" href="/assets/js/56.9cb359b8.js"><link rel="prefetch" href="/assets/js/57.431a19c0.js"><link rel="prefetch" href="/assets/js/58.973f2856.js"><link rel="prefetch" href="/assets/js/59.0a94885e.js"><link rel="prefetch" href="/assets/js/6.13c9cae7.js"><link rel="prefetch" href="/assets/js/60.5ab22bfd.js"><link rel="prefetch" href="/assets/js/61.7382147b.js"><link rel="prefetch" href="/assets/js/62.053f6364.js"><link rel="prefetch" href="/assets/js/63.f1ec3fde.js"><link rel="prefetch" href="/assets/js/64.d44fc7f8.js"><link rel="prefetch" href="/assets/js/65.4014054d.js"><link rel="prefetch" href="/assets/js/66.b930f611.js"><link rel="prefetch" href="/assets/js/67.31a76574.js"><link rel="prefetch" href="/assets/js/68.86a9db75.js"><link rel="prefetch" href="/assets/js/69.549b9e05.js"><link rel="prefetch" href="/assets/js/7.7c50b4ce.js"><link rel="prefetch" href="/assets/js/70.974cb42b.js"><link rel="prefetch" href="/assets/js/71.74ba66e3.js"><link rel="prefetch" href="/assets/js/72.2c23e8de.js"><link rel="prefetch" href="/assets/js/73.6b72b29c.js"><link rel="prefetch" href="/assets/js/74.0473ac40.js"><link rel="prefetch" href="/assets/js/75.b78ee633.js"><link rel="prefetch" href="/assets/js/76.3af49e37.js"><link rel="prefetch" href="/assets/js/77.97550fb2.js"><link rel="prefetch" href="/assets/js/78.21e06f35.js"><link rel="prefetch" href="/assets/js/79.62226278.js"><link rel="prefetch" href="/assets/js/80.23b7ca6f.js"><link rel="prefetch" href="/assets/js/81.6f755e25.js"><link rel="prefetch" href="/assets/js/82.0945517d.js"><link rel="prefetch" href="/assets/js/83.e3e65397.js"><link rel="prefetch" href="/assets/js/84.7d198a55.js"><link rel="prefetch" href="/assets/js/85.0fcd2c1c.js"><link rel="prefetch" href="/assets/js/86.85c6f3f5.js"><link rel="prefetch" href="/assets/js/87.9bd1d572.js"><link rel="prefetch" href="/assets/js/88.bcc8377f.js"><link rel="prefetch" href="/assets/js/89.8fce751f.js"><link rel="prefetch" href="/assets/js/9.7f1824f2.js"><link rel="prefetch" href="/assets/js/90.44dbb861.js"><link rel="prefetch" href="/assets/js/91.345b1c79.js"><link rel="prefetch" href="/assets/js/92.6bf6e00c.js"><link rel="prefetch" href="/assets/js/93.8d19d73b.js"><link rel="prefetch" href="/assets/js/94.772100c2.js"><link rel="prefetch" href="/assets/js/95.ce91d601.js"><link rel="prefetch" href="/assets/js/96.8d30a998.js"><link rel="prefetch" href="/assets/js/97.9cbf8286.js"><link rel="prefetch" href="/assets/js/98.1c191ea1.js"><link rel="prefetch" href="/assets/js/99.5d892338.js">
    <link rel="stylesheet" href="/assets/css/0.styles.878da1ec.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">roadaspen's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/arithmetic/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/book/" class="nav-link">
  阅读
</a></div><div class="nav-item"><a href="/cookbook/" class="nav-link">
  菜谱
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/arithmetic/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/book/" class="nav-link">
  阅读
</a></div><div class="nav-item"><a href="/cookbook/" class="nav-link">
  菜谱
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>前端工程化</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/engineering/前端代码开发规范.html" class="sidebar-link">前端代码开发规范</a></li><li><a href="/blog/engineering/node管理工具.html" class="sidebar-link">node 管理工具</a></li><li><a href="/blog/engineering/Mock方案.html" class="sidebar-link">Mock 方案</a></li><li><a href="/blog/engineering/git.html" class="sidebar-link">git</a></li><li><a href="/blog/engineering/commitlint.html" class="sidebar-link">CommitLint</a></li><li><a href="/blog/engineering/打造自己的脚手架.html" class="sidebar-link">从零打造自己的脚手架</a></li><li><a href="/blog/engineering/Eslint插件开发.html" class="sidebar-link">Eslint 插件开发</a></li><li><a href="/blog/engineering/rollup.html" class="sidebar-link">rollup</a></li><li><a href="/blog/engineering/glup.html" class="sidebar-link">glup</a></li><li><a href="/blog/engineering/monorepo.html" aria-current="page" class="active sidebar-link">什么是 Monorepo</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/engineering/monorepo.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/blog/engineering/monorepo.html#什么是-monorepo-2" class="sidebar-link">什么是 Monorepo</a></li><li class="sidebar-sub-header"><a href="/blog/engineering/monorepo.html#monorepo-的进化之路" class="sidebar-link">Monorepo 的进化之路</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/engineering/monorepo.html#monorepo-的优劣" class="sidebar-link">Monorepo 的优劣</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/engineering/monorepo.html#monorepo-的场景" class="sidebar-link">MonoRepo 的场景</a></li><li class="sidebar-sub-header"><a href="/blog/engineering/monorepo.html#monorepo-踩坑" class="sidebar-link">MonoRepo 踩坑</a></li><li class="sidebar-sub-header"><a href="/blog/engineering/monorepo.html#monorepo-选型" class="sidebar-link">Monorepo 选型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/engineering/monorepo.html#构建型" class="sidebar-link">构建型</a></li><li class="sidebar-sub-header"><a href="/blog/engineering/monorepo.html#轻量型" class="sidebar-link">轻量型</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/engineering/monorepo.html#选型建议" class="sidebar-link">选型建议</a></li></ul></li><li><a href="/blog/engineering/pnpm.html" class="sidebar-link">pnpm</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ReactNative</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Framework</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>运维相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微前端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="什么是-monorepo"><a href="#什么是-monorepo" class="header-anchor">#</a> 什么是 Monorepo</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>最近入职了一家新公司，公司代码采用了前端 React、后端 nest.js 的技术栈，很多方法都是可以前后端公用的，前后端所有的代码都放在同一个代码仓库中，采用了 monorepo 的代码管理方案，在这里开始了解一下什么是 monorepo，以及 对应的 multi-repo 有什么区别。</p> <h2 id="什么是-monorepo-2"><a href="#什么是-monorepo-2" class="header-anchor">#</a> 什么是 Monorepo</h2> <p>所谓的 <code>Monorepo</code> 就是一个 git 仓库，里面存放着多个项目，这样的项目被称为工作空间或者包,这些包可以相互依赖，也可以完全不相关。与此相反，使用多个 git 仓库，每个 git 仓库只存放一个项目，称为 <code>Multi-repo</code> 方式。也可以将这两种方式的结合起来使用。
越来越多的公司开始使用 Monorepo 作为公司代码仓库的管理方案，包括 Google、Facebook、Twitter 。想象一下，想 Babel、React、Ember 这样的项目，他们由一
个核心的包组成，可以通过包形式的附加组件和功能进行扩展，在一个存储库中同时管理项目的 Core 和 plugin 使得维护代码的代价更小，也能更好的保持所有版本依赖保持同步。</p> <h2 id="monorepo-的进化之路"><a href="#monorepo-的进化之路" class="header-anchor">#</a> Monorepo 的进化之路</h2> <p><strong>阶段一：单仓库巨石应用</strong> 一个 git 仓库维护所有的代码，随着代码量的逐渐扩大和业务量的逐步上升，项目代码会越来越大，越来越复杂，大量代码的构建效率降低，最后导致了单仓库巨石应用，称为 <code>Monolith</code>。<br> <strong>阶段二：多仓库多模块应用</strong> 随着代码量的增多，将整体业务拆解成为多个业务模块，各自做为一个 <code>git仓库管理</code>,模块之间解耦合，降低了 巨石应用的复杂度，每个模块都可以单独编码、测试、发版，构建效率得到很大的提升，这种代码管理方式称为 <code>Multi-repo</code>.<br> <strong>阶段三：单仓库多模块应用</strong> 随着业务模块继续增加，模块仓库的数量也在不断增多，Multi-repo 方式虽然从业务上解耦合，但也增加了项目工程管理的难度，随着模块仓库达到一定的数量级，会有几个问题： 跨仓库代码很难共享，分散在单仓库的模块依赖管理复杂，
底层模块升级，上层依赖模块都要及时更新，否则就存在依赖问题，增加了构建耗时（一个底层模块提交更新，所有依赖模块都要做依赖更新及 git 提交，发版，非常耗时耗力），于是将多个项目集成到一个仓库下，共享仓库配置，共享模块代码，共享第三方依赖（保证了三方依赖的版本统一）称为趋势，这种代码管理方式称之为 <code>MonoRepo</code>.</p> <p><img src="/assets/img/monorepo.9d3de06b.jpg" alt="monorepo"></p> <h3 id="monorepo-的优劣"><a href="#monorepo-的优劣" class="header-anchor">#</a> Monorepo 的优劣</h3> <p><img src="/assets/img/monorepo-git.9a41147d.jpg" alt="monorepo和multi-repo的区别"></p> <table><thead><tr><th>场景</th> <th>MultiRepo</th> <th>MonoRepo</th></tr></thead> <tbody><tr><td>代码可见性</td> <td>✅ 代码隔离，研发者只需要关注自己负责的仓库<br> ❌ 管理按照各自的 Owner 划分，当出现问题时，需要到依赖包中进行判断并解决</td> <td>✅ 一个仓库中由多个相关项目，可以看到整个代码库的变化趋势，更好的团队协作 <br>❌ 增加了非 Owner 代码改动的风险</td></tr> <tr><td>依赖管理</td> <td>❌ 多个仓库都有自己的 node_modules</td> <td>✅ 所有的项目在一个文件夹中，依赖提升，共享一个 node_modules</td></tr> <tr><td>代码权限</td> <td>✅ 每个仓库都可以设置自己的代码权限，不会出现项目被误改的情况</td> <td>❌ 多个项目代码在同一个仓库中，没有项目粒度的权限 ，一个项目出问题，可能影响到所有项目</td></tr> <tr><td>开发迭代</td> <td>✅ 仓库体积小，模块划分清晰，可维护性强 <br>❌ 多仓库来回切换（编辑器和命令行），项目多时效率很低，存在相同依赖时，需要手动 npm link，操作繁琐 <br>❌ 依赖管理不便，多个依赖可能在不同的项目中存在不同的版本，重复安装，npm link 时不同项目的依赖会存在冲突</td> <td>✅ 多个代码在同一个仓库中，可以看到相关项目的全貌，编码非常方便<br> ✅ 代码复用高，方便进行重构 ❌ 多个项目在同一个项目中，代码体积很大，git clone 操作时间很长， 在开发过程中 rebase 会很耗费时间，需要经常 rebase，特别是多人开发相同模块的时候，容易冲突 <br> ✅ 依赖调试方便，在迭代依赖包的时候，只需要 npm link 一次，就可以在多个项目中查看修改效果，简化了操作流程</td></tr> <tr><td>工程配置</td> <td>❌ 各个仓库各自维护一套构建、打包、代码校验，不一致时或者需要构建优化时可能导致代码差异和构建差异</td> <td>✅ 多个项目在同一个仓库，共用同一套工程配置逻辑，代码风格、代码质量标准容易把控</td></tr> <tr><td>构建部署</td> <td>❌ 各个仓库存在相同的依赖升级时，需要手动到各个仓库修改依赖版本，构建和部署，非常消耗时间</td> <td>✅ 构建 Monorepo 工具可以配置依赖项目的构建优先级，可以实现一次命令完成所有部署</td></tr></tbody></table> <h2 id="monorepo-的场景"><a href="#monorepo-的场景" class="header-anchor">#</a> MonoRepo 的场景</h2> <p>综合以上所述， MonoRepo 的管理方式更适用于 <code>中大型项目，多模块项目</code>，在开发效率、协作效率、综合管理、代码一致性等方面都有很大收益</p> <h2 id="monorepo-踩坑"><a href="#monorepo-踩坑" class="header-anchor">#</a> MonoRepo 踩坑</h2> <p>一、<strong>幽灵依赖</strong></p> <p><strong>问题：</strong> npm、yarn 安装的依赖，存在依赖提升，即所有的依赖全部摊平到同一层级，这就导致一些没有在 package.json 中引入的依赖包，也可以在项目中直接使用，这种行为就叫做 <strong>&quot;幽灵依赖&quot;</strong>，幽灵依赖最大的问题在于，如果某个幽灵依赖不再被其他包使用，不再被安装，那么项目就会因为无法找到依赖而报错。</p> <p><strong>解决方案：</strong> 基于 npm、yarn 的 Monorepo 的方案依然存在幽灵依赖的问题，目前可以使用 <code>pnpm</code>彻底解决这个问题。</p> <p>二、<strong>依赖安装耗时长</strong></p> <p><strong>问题：</strong> MonoRepo 中每个项目都有自己的 package.json 依赖表，嘴着 MonoRepo 中依赖增常，每次 install 的耗时会越来愈长<br> <strong>方案：</strong> 相同版本的依赖可以提升到 MonoRepo 根目录下，减少冗余依赖的安装，使用 pnpm 按需安装及依赖缓存</p> <p>三、<strong>构建打包时间长</strong><br> <strong>问题：</strong> 多个项目构建任务存在依赖时，往往是串行构建或者全量构建，导致构建时间长<br> <strong>方案：</strong> 增量构建，而非全量构建，也可以将串行构建优化成并行构建。</p> <h2 id="monorepo-选型"><a href="#monorepo-选型" class="header-anchor">#</a> Monorepo 选型</h2> <h3 id="构建型"><a href="#构建型" class="header-anchor">#</a> 构建型</h3> <p>目前市面上有很多基于 Monorepo 思想构建的工具，主要解决大仓库 Monorepo 构建效率低的问题。项目代码越来越大，工作流程（项目 init、构建、单元测试、集成测试）越来越慢；这类工具就是针对这样的场景进行极致的性能优化。适用于包非常多、代码量非常庞大的 Monorepo 项目。</p> <h3 id="轻量型"><a href="#轻量型" class="header-anchor">#</a> 轻量型</h3> <h4 id="lerna"><a href="#lerna" class="header-anchor">#</a> Lerna</h4> <p><strong>Lerna 是什么？</strong></p> <ul><li>Lerna 是 Babel 为实现 MonoRepo 开发的工具；最擅长依赖关系和发布</li> <li>Lerna 优化了多包工作流，解决了多包依赖、发版手动维护等问题</li> <li>Lerna 不提供构建、测试等任务，工程能力较弱，项目中往往需要基于它进行顶层能力的封装</li></ul> <p><strong>Lerna 主要做的三件事</strong></p> <ul><li>为单个包或者多个包运行命令 （lerna run）</li> <li>管理依赖项 （lerna bootstrap）</li> <li>发布依赖包，处理版本管理，并声称变更日志（lerna publish）</li></ul> <p><strong>Lerna 解决了什么问题？</strong></p> <ul><li><strong>代码共享、调试便捷：</strong> 一个依赖包更新，其他依赖包无需安装最新版本，因为 lerna 会自动 link</li> <li><strong>安装依赖，减少冗余</strong> 多个包使用相同版本的依赖包时，Lerna 优先将依赖包安装在根目录</li> <li>**规范版本管理：**Lerna 通过 Git 检测代码变动，自动发版，更新版本好，两种模式管理多个依赖包的版本号</li> <li><strong>自动生成发版日志：</strong> 使用插件，根据 Git commit 记录，自动生成 ChangeLog</li></ul> <p><strong>Lerna 自动检测发布，判断逻辑</strong></p> <ol><li>校验本地是否有没有被 commit 内容？</li> <li>判断当前的分支是否正常？</li> <li>判断当前分支是否在 remote 存在？</li> <li>判断当前分支是否在 lerna.json 允许的 allowBranch 设置之中？</li> <li>判断当前分支提交是否落后于 remote</li></ol> <p><strong>Lerna 工作模式</strong><br>
Lerna 可以使用两种模式来管理项目 <strong>固定模式</strong> 所有的包都拥有同样的版本、<strong>独立模式</strong> 包可以拥有自己的单独版本号</p> <h4 id="yarn-npm-workspace"><a href="#yarn-npm-workspace" class="header-anchor">#</a> yarn\npm + workspace</h4> <p>yarn 1.x 及以上版本，新增 workspace 能力，不借助 Lerna ，也可以提供原声的 Monorepo 支持，需要在根目录下 package.json 中，声明 workspace</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token string">&quot;private&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 必须是私有项目</span>
    <span class="token string">&quot;workspaces&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;packages&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;packages/backend&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;packages/frontend&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;packages/shared&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;vendors/**&quot;</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>yarn workspace VS Lerna</strong></p> <ul><li><p>yarn workspace 更突出对依赖的管理： 依赖提升到根目录的 node_modules 下，安装更快，体积更小</p></li> <li><p>Lerna 更突出工作流方面：使用 Lerna 命令来优化多个包的管理，如：依赖发包、版本管理，批量执行脚本</p></li></ul> <p>将二者结合起来使用，会形成更佳方案： <strong>yarn workspace + Lerna</strong></p> <p>能力分工：Lerna 将依赖管理交给 yarn workspace；Lerna 承担依赖发布能力。</p> <p><strong>操作步骤：</strong></p> <ol><li>配置 Lerna 使用 Yarn 管理依赖：learn.json 中配置 &quot;npmClient&quot;: &quot;yarn&quot;</li> <li>配置 Lerna 启用 Yarn Workspaces：</li></ol> <blockquote><p>配置 lerna.json/useWorkspaces = true
配置根目录 package.json/workspaces = [&quot;packages/*&quot;] , 此时 lerna.json 中的 packages 配置项将不再使用.
配置根目录 package.json/private = true</p></blockquote> <p>说明：
上面三个配置项需同时开启, 只开启一个 lerna 会报错
此时执行 lerna bootstrap 相当于执行 yarn install，等同于执行 lerna bootstrap --npm-client yarn --use-workspaces
由于 yarn 会自动 hosit 依赖包, 无需再 lerna bootstrap 时增加参数 --hoist (加了参数 lerna 也会报错)</p> <p>不需要发包的项目，配置 package.json/private = true</p> <h4 id="lerna-pnpm-workspace"><a href="#lerna-pnpm-workspace" class="header-anchor">#</a> Lerna + pnpm + workspace</h4> <p><strong>pnpm 是新一代 Node 包管理器</strong>，它由 npm/yarn 衍生而来，解决了 npm/yarn 内部潜在的风险，并且极大提升依赖安装速度。pnpm 内部使用基于内容寻址的文件系统，来管理磁盘上依赖，减少依赖安装；node_modules/.pnpm 为虚拟存储目录，该目录通过<package-name>@<version>来实现相同模块不同版本之间隔离和复用，由于它只会根据项目中的依赖生成，并不存在提升。
<strong>CAS 内容寻址存储</strong>，是一种存储信息的方式，根据内容而不是位置进行检索信息的存储方式。<br> <strong>Virtual store 虚拟存储</strong>，指向存储的链接的目录，所有直接和间接依赖项都链接到此目录中，项目当中的.pnpm 目录</version></package-name></p> <p><strong>pnpm 相比于 npm、yarn 的包管理器，优势如下，同理是 Lerna + yarn + workspace 优势：</strong></p> <ul><li><strong>装包速度极快</strong>： 缓存中有的依赖，直接硬链接到项目的 node_module 中；减少了 copy 的大量 IO 操作</li> <li><strong>磁盘利用率极高</strong>： 软/硬链接方式，同一版本的依赖共用一个磁盘空间；不同版本依赖，只额外存储 diff 内容</li> <li><strong>解决了幽灵依赖</strong>： node_modules 目录结构 与 package.json 依赖列表一致</li></ul> <h2 id="选型建议"><a href="#选型建议" class="header-anchor">#</a> 选型建议</h2> <p>建议采用渐进式架构方案，即对于轻量级 Monorepo 项目，我们初期可以选择 <code>Lerna + pnpm workspace + lerna-changelog</code>，解决了依赖管理、发版管理等问题，为开发者带来便利；随着后续项目迭代，代码变多或多个项目间依赖关系复杂，可以很平滑的接入 Nx 来提升构建打包效率。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">11/1/2023, 2:28:39 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/engineering/glup.html" class="prev">
        glup
      </a></span> <span class="next"><a href="/blog/engineering/pnpm.html">
        pnpm
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.54ff6683.js" defer></script><script src="/assets/js/2.b5bd4e97.js" defer></script><script src="/assets/js/8.bc8f262b.js" defer></script>
  </body>
</html>
